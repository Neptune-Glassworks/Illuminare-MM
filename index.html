<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Illuminare Mind Map</title>
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <!-- 1) Load the font first -->
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
      
  <style>
    /* 1) Base resets & default gradient */
    html, body {
      margin: 0;
      padding: 0;
      height: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: linear-gradient(to bottom, #2A2A2A, #1F1F1F);
    }

    /* 2) Blend‐mode overlay */
    @supports (background-blend-mode: overlay) {
      html, body {
        background-image:
          url('paper_texture.png'),
          linear-gradient(to bottom, #2A2A2A, #1F1F1F);
        background-repeat: repeat, no-repeat;
        background-size: auto, cover;
        background-blend-mode: overlay;
      }
    }

    #cy-wrapper {
      width: 100%;
      height: auto;
      position: relative;
      padding-bottom: 40vh;
    }

    #cy {
      width: 100%;
      height: 100vh;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div id="cy-wrapper">
    <div id="cy"></div>
  </div>

  <script>
    fetch('data/neptune_theme_network_classified.json')
      .then(res => res.json())
      .then(data => {

        
const cy = cytoscape({
  container: document.getElementById('cy'),
  elements: data.elements,

  style: [

    // 1) Theme nodes (bigger, dark olive, soft glow)
    {
      selector: 'node.theme',
      style: {
        'background-color': '#1B2A22',
        'label': 'data(name)',
        'font-family': 'DM Sans, sans-serif',
        'font-size': '32px',
        'text-valign': 'center',
        'color': '#FFF',
        'text-outline-color': '#1F1F1F',
        'text-outline-width': '0.5px',
        'width': 46,
        'height': 46,
      }
    },

    // 2) Glow rings (unchanged)
    {
      selector: '.glow-ring',
      style: {
        'background-color': '#FFD700',
        'opacity': 0.25,
        'width': 20,
        'height': 20,
        'z-index': 0,
        'shape': 'ellipse',
        'events': 'no',
        'label': ''
      }
    },

    // 3) Lamp fixtures with new warm/cool palette
    {
      selector: 'node.lamp.chandelier',
      style: { 'background-color': '#F5F1E8', 'width': 25, 'height': 25 }
    },
    {
      selector: 'node.lamp.pendant',
      style: { 'background-color': '#7E9BAE', 'width': 25, 'height': 25 }
    },
    {
      selector: 'node.lamp.sconce',
      style: { 'background-color': '#D9BCA3', 'width': 25, 'height': 25 }
    },
    {
      selector: 'node.lamp.table',
      style: { 'background-color': '#E6C4C9', 'width': 25, 'height': 25 }
    },
    {
      selector: 'node.lamp.floor',
      style: { 'background-color': '#A5A77B', 'width': 25, 'height': 25 }
    },
    {
      selector: 'node.lamp.outdoor',
      style: { 'background-color': '#B7D1C5', 'width': 25, 'height': 25 }
    },

    // 4) Default nodes (labels, text outlines)
    {
      selector: 'node',
      style: {
        'label': 'data(name)',
        'font-family': 'DM Sans, sans-serif',
        'font-size': '20px',
        'text-valign': 'center',
        'color': '#FFF',
        'text-outline-color': '#1F1F1F',
        'text-outline-width': '0.5px'

      }
    },

    // 5) Default edges (dashed, light opacity)
    {
      selector: 'edge',
      style: {
        'width': 1.5,
        'line-color': '#E1E7ED',
        'line-style': 'dashed',
        'opacity': 0.5,
        'line-dash-pattern': [6, 4],
        'curve-style': 'unbundled-bezier',
        'edge-distances': 'node-position',
        'control-point-distances': 0,
        'control-point-weights': 0.5
      }
    },

    // 6) Highlighted edges (on hover)
    {
      selector: 'edge.highlighted-edge',
      style: {
        'opacity': 1
      }
    }

  ],  // end of style array

  layout: { name: 'preset' },

  // KEEP THESE EXACTLY AS IS:
  userZoomingEnabled: false,
  wheelSensitivity: 0.2
});

        // ✨ Animate dashed theme-to-lamp edges
        let dashOffset = 0;
        let frameCount = 0;
        function animateThemeToLampEdges() {
          frameCount++;
          if (frameCount % 3 === 0) {
            dashOffset = (dashOffset - 1 + 10) % 10;
            cy.edges().forEach(edge => {
              const source = edge.source();
              const target = edge.target();
              if (source.hasClass('theme') && target.hasClass('lamp')) {
                edge.style('line-dash-offset', dashOffset);
              }
            });
          }
          requestAnimationFrame(animateThemeToLampEdges);
        }
        requestAnimationFrame(animateThemeToLampEdges);

// ✅ Block Cytoscape zoom on scroll, allow page scroll manually
        let zoomResetTimer;
cy.container().addEventListener('wheel', function (e) {
  const isPinchZoom = e.ctrlKey || e.metaKey;
  const isVerticalScroll = Math.abs(e.deltaY) > Math.abs(e.deltaX);

  if (isPinchZoom) {
    e.preventDefault(); // ✅ this one line helps Chrome/Firefox stop hijacking
    cy.userZoomingEnabled(true);
    clearTimeout(zoomResetTimer);
    zoomResetTimer = setTimeout(() => {
      cy.userZoomingEnabled(false);
    }, 300);
  } else if (isVerticalScroll) {
    e.stopPropagation();
  }
}, { passive: false });
        
        // 🎯 Position edges with curvature
        const curveFactor = -0.35;
        cy.edges().forEach(edge => {
          const src = edge.source().position();
          const tgt = edge.target().position();
          const dx = tgt.x - src.x;
          const dy = tgt.y - src.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          edge.style({
            'control-point-distances': [curveFactor * dist],
            'control-point-weights': [0.5]
          });
        });

        cy.center(); // prevents zooming out so far that it's invisible
        cy.zoom(.65); // or whatever feels balanced

// New Container ->
        <style>
  .legend {
    position: absolute;
    background: rgba(255,255,255,0.9);
    padding: 8px;
    border-radius: 4px;
    font: 14px DM Sans, sans-serif;
    right: 20px;  /* initial offsets, will be overridden by JS */
    bottom: 20px;
  }
</style>
<body>
  <div id="cy-wrapper">
    <div id="cy"></div>
    <div class="legend">
      <strong>Legend<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Illuminare Mind Map</title>

  <!-- Cytoscape.js -->
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <!-- DM Sans -->
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* —————————————————————————— *
       Global & Background
    * —————————————————————————— */
    html, body {
      margin: 0;
      padding: 0;
      height: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      background: linear-gradient(to bottom, #2A2A2A, #1F1F1F);
    }
    @supports (background-blend-mode: overlay) {
      html, body {
        background-image:
          url('paper_texture.png'),
          linear-gradient(to bottom, #2A2A2A, #1F1F1F);
        background-repeat: repeat, no-repeat;
        background-size: auto, cover;
        background-blend-mode: overlay;
      }
    }

    /* —————————————————————————— *
       Cytoscape Wrapper
    * —————————————————————————— */
    #cy-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 40vh; /* extra vertical scroll room */
    }
    #cy {
      width: 100%;
      height: 100vh; /* fill viewport */
      pointer-events: auto;
    }

    /* —————————————————————————— *
       Legend Styling
    * —————————————————————————— */
    .legend {
      position: absolute;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      border-radius: 4px;
      font: 14px "DM Sans", sans-serif;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      line-height: 1.4;
      pointer-events: none; /* clicks pass through */
    }
    .legend strong { display: block; margin-bottom: 4px; }
    .legend .swatch {
      display: inline-block;
      width: 0.8em; height: 0.8em;
      margin-right: 6px;
      vertical-align: middle;
      border-radius: 50%;
    }
  </style>
</head>

<body>
  <div id="cy-wrapper">
    <div id="cy"></div>

    <!-- Legend markup -->
    <div class="legend">
      <strong>Legend</strong>
      <div><span class="swatch" style="background:#F5F1E8"></span>Chandelier</div>
      <div><span class="swatch" style="background:#7E9BAE"></span>Pendant</div>
      <div><span class="swatch" style="background:#D9BCA3"></span>Sconce</div>
      <div><span class="swatch" style="background:#E6C4C9"></span>Table Lamp</div>
      <div><span class="swatch" style="background:#A5A77B"></span>Floor Lamp</div>
      <div><span class="swatch" style="background:#B7D1C5"></span>Outdoor</div>
      <div><span class="swatch" style="background:#1B2A22"></span>Theme Node</div>
    </div>
  </div>

  <script>
  fetch('data/neptune_theme_network_classified.json')
    .then(res => res.json())
    .then(data => {
      const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: data.elements,
        style: [
          // theme nodes
          {
            selector: 'node.theme',
            style: {
              'background-color': '#1B2A22',
              'label': 'data(name)',
              'font-family': 'DM Sans, sans-serif',
              'font-size': 32,
              'text-valign': 'center',
              'color': '#FFF',
              'text-outline-color': '#1F1F1F',
              'text-outline-width': 0.5,
              'width': 46,
              'height': 46
            }
          },
          // glow rings
          {
            selector: '.glow-ring',
            style: {
              'background-color': '#FFD700',
              'opacity': 0.25,
              'width': 20,
              'height': 20,
              'z-index': 0,
              'shape': 'ellipse',
              'events': 'no',
              'label': ''
            }
          },
          // fixture palettes
          {
            selector: 'node.lamp.chandelier', style: { 'background-color': '#F5F1E8', 'width': 25, 'height': 25 }
          },
          {
            selector: 'node.lamp.pendant', style: { 'background-color': '#7E9BAE', 'width': 25, 'height': 25 }
          },
          {
            selector: 'node.lamp.sconce', style: { 'background-color': '#D9BCA3', 'width': 25, 'height': 25 }
          },
          {
            selector: 'node.lamp.table', style: { 'background-color': '#E6C4C9', 'width': 25, 'height': 25 }
          },
          {
            selector: 'node.lamp.floor', style: { 'background-color': '#A5A77B', 'width': 25, 'height': 25 }
          },
          {
            selector: 'node.lamp.outdoor', style: { 'background-color': '#B7D1C5', 'width': 25, 'height': 25 }
          },
          // default node label
          {
            selector: 'node',
            style: {
              'label': 'data(name)',
              'font-family': 'DM Sans, sans-serif',
              'font-size': 20,
              'text-valign': 'center',
              'color': '#FFF',
              'text-outline-color': '#1F1F1F',
              'text-outline-width': 0.5
            }
          },
          // edges
          {
            selector: 'edge',
            style: {
              'width': 1.5,
              'line-color': '#E1E7ED',
              'line-style': 'dashed',
              'opacity': 0.5,
              'line-dash-pattern': [6, 4],
              'curve-style': 'unbundled-bezier',
              'edge-distances': 'node-position',
              'control-point-distances': 0,
              'control-point-weights': 0.5
            }
          },
          {
            selector: 'edge.highlighted-edge',
            style: { 'opacity': 1 }
          }
        ],
        layout: { name: 'preset' },
        userZoomingEnabled: false,
        wheelSensitivity: 0.2
      });

      // animated dashes
      let dashOffset = 0, frame = 0;
      (function animate(){
        frame++;
        if(frame % 3 === 0){
          dashOffset = (dashOffset - 1 + 10) % 10;
          cy.edges().filter(e => e.source().hasClass('theme') && e.target().hasClass('lamp'))
            .forEach(e => e.style('line-dash-offset', dashOffset));
        }
        requestAnimationFrame(animate);
      })();

      // curvature
      const factor = -0.35;
      cy.edges().forEach(edge => {
        const s = edge.source().position();
        const t = edge.target().position();
        const d = Math.hypot(t.x - s.x, t.y - s.y);
        edge.style({
          'curve-style': 'unbundled-bezier',
          'control-point-distances': factor * d,
          'control-point-weights': 0.5
        });
      });

      // center & zoom
      cy.center();
      cy.zoom(0.65);

      // hover glow & highlight
      const glowSet = new Set(), hoverSet = new Set();
      cy.on('mouseover', 'node', evt => {
        const n = evt.target, id = n.id(), glowId = `glow-${id}`;
        if(!n.data('url') || n.hasClass('glow-ring') || hoverSet.has(id) || glowSet.has(glowId)) return;
        hoverSet.add(id); glowSet.add(glowId);
        cy.add({ group:'nodes', data:{id:glowId}, position:n.position(), classes:'glow-ring' })
          .animate({ style:{ width:n.width()*5, height:n.height()*5, opacity:0 }}, {
            duration:600, easing:'ease-out',
            complete: ()=>{ cy.getElementById(glowId).remove(); glowSet.delete(glowId); }
          });
      });
      cy.on('mouseout','node', evt=> hoverSet.delete(evt.target.id()));
      cy.on('tap','node', evt=>{ const u=evt.target.data('url'); if(u) window.open(u); });
      cy.nodes('.theme, .lamp')
        .on('mouseover', e => e.target.connectedEdges().addClass('highlighted-edge'))
        .on('mouseout',  e => e.target.connectedEdges().removeClass('highlighted-edge'));

      // legend positioning
      function positionLegend(){
        const wrap = document.getElementById('cy-wrapper');
        if(!wrap) return;
        const r = wrap.getBoundingClientRect();
        const lg = document.querySelector('.legend');
        lg.style.top  = `${r.bottom - lg.offsetHeight - 10}px`;
        lg.style.left = `${r.right  - lg.offsetWidth  - 10}px`;
      }
      window.addEventListener('resize', positionLegend);
      positionLegend();
    });
  </script>
</body>
</html></strong><br>
      ● Chandelier<br>
      ● Pendant<br>
      <!-- etc… -->
    </div>
  </div>
  <script>
    // … your cytoscape init …

    function positionLegend() {
      const wrapper = document.getElementById('cy-wrapper');
      if (!wrapper) return;
      const rect   = wrapper.getBoundingClientRect();
      const legend = document.querySelector('.legend');
      legend.style.top  = `${rect.bottom - legend.offsetHeight - 10}px`;
      legend.style.left = `${rect.right  - legend.offsetWidth  - 10}px`;
    }

    window.addEventListener('resize', positionLegend);
    positionLegend();
  </script>
</body>
// <- End of new container
  
        // 💡 Glow and highlight
        const glowCooldown = new Set();
        const activeHoverSet = new Set();

        cy.on('mouseover', 'node', function(evt) {
          const node = evt.target;
          const nodeId = node.id();
          const glowId = 'glow-' + nodeId;
          if (!node.data('url') || node.hasClass('glow-ring')) return;
          if (activeHoverSet.has(nodeId) || glowCooldown.has(glowId)) return;

          activeHoverSet.add(nodeId);
          glowCooldown.add(glowId);

          cy.add({
            group: 'nodes',
            data: { id: glowId },
            position: node.position(),
            classes: 'glow-ring'
          });

          const glow = cy.getElementById(glowId);
          glow.animate({
            style: {
              'width': node.width() * 5,
              'height': node.height() * 5,
              'opacity': 0
            }
          }, {
            duration: 600,
            easing: 'ease-out',
            complete: () => {
              glow.remove();
              glowCooldown.delete(glowId);
            }
          });
        });

        cy.on('mouseout', 'node', evt => {
          activeHoverSet.delete(evt.target.id());
        });

        cy.on('tap', 'node', evt => {
          const url = evt.target.data('url');
          if (url) window.open(url, '_blank');
        });

        // Highlight edges on theme node hover
        cy.nodes('.theme, .lamp')
  .on('mouseover', evt => {
    evt.target.connectedEdges().addClass('highlighted-edge');
  })
  .on('mouseout', evt => {
    evt.target.connectedEdges().removeClass('highlighted-edge');
  });
      });
  </script>
</body>
</html>
